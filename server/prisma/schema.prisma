generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                 String              @id @default(uuid())
  email              String              @unique
  passwordHash       String?
  name               String?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  dateOfBirth        DateTime?
  gender             String?
  timezone           String?             @default("America/Chicago")
  heightCm           Float?
  weightKg           Float?
  activityLevel      ActivityLevel?
  isVerified         Boolean             @default(false)
  acceptedTermsAt    DateTime?
  googleSub          String?             @unique
  appleSub String? @unique
  photoUrl           String?
  meals              Meal[]
  symptomLogs        SymptomLog[]
  allergies          UserAllergy[]
  UserPreferences    UserPreferences?
  verificationTokens VerificationToken[]
  
}

model Allergy {
  id            Int            @id @default(autoincrement())
  name          String         @unique
  description   String?
  foods         FoodAllergen[]
  userAllergies UserAllergy[]
}

model UserAllergy {
  id        Int     @id @default(autoincrement())
  userId    String
  allergyId Int
  severity  Int?
  note      String?
  allergy   Allergy @relation(fields: [allergyId], references: [id], onDelete: Cascade)
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, allergyId])
}

model Food {
  id          Int            @id @default(autoincrement())
  name        String
  brand       String?
  description String?
  servingSize Float?
  servingUnit String?
  calories    Float?
  protein     Float?
  carbs       Float?
  fat         Float?
  fiber       Float?
  sugar       Float?
  sodium      Float?
  barcode     String?        @unique
  imageUrl    String?
  source      FoodSource     @default(MANUAL)
  externalId  String?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  allergens   FoodAllergen[]
  mealItems   MealItem[]

  @@index([brand])
  @@index([name])
}

model FoodAllergen {
  id        Int     @id @default(autoincrement())
  foodId    Int
  allergyId Int
  contains  Boolean @default(true)
  level     String?
  allergy   Allergy @relation(fields: [allergyId], references: [id], onDelete: Cascade)
  food      Food    @relation(fields: [foodId], references: [id], onDelete: Cascade)

  @@unique([foodId, allergyId])
}

model Meal {
  id          Int          @id @default(autoincrement())
  userId      String
  dateTime    DateTime
  mealType    MealType
  note        String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  items       MealItem[]
  symptomLogs SymptomLog[] @relation("MealSymptoms")
}

model MealItem {
  id       Int     @id @default(autoincrement())
  mealId   Int
  foodId   Int
  quantity Float   @default(1)
  unit     String?
  notes    String?
  calories Float?
  protein  Float?
  carbs    Float?
  fat      Float?
  fiber    Float?
  sugar    Float?
  sodium   Float?
  food     Food    @relation(fields: [foodId], references: [id])
  meal     Meal    @relation(fields: [mealId], references: [id], onDelete: Cascade)
}

model Symptom {
  id          Int          @id @default(autoincrement())
  name        String       @unique
  description String?
  logs        SymptomLog[]
}

model SymptomLog {
  id            Int      @id @default(autoincrement())
  userId        String
  symptomId     Int
  startedAt     DateTime @default(now())
  severity      Int?
  notes         String?
  relatedMealId Int?
  createdAt     DateTime @default(now())
  relatedMeal   Meal?    @relation("MealSymptoms", fields: [relatedMealId], references: [id])
  symptom       Symptom  @relation(fields: [symptomId], references: [id])
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  id        Int                   @id @default(autoincrement())
  userId    String
  token     String                @unique
  type      VerificationTokenType
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime              @default(now())
  user      User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model UserPreferences {
  id                 String   @id
  userId             String   @unique
  allergies          String[] @default([])
  dietaryPreferences String[] @default([])
  User               User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

enum ActivityLevel {
  SEDENTARY
  LIGHT
  MODERATE
  ACTIVE
  VERY_ACTIVE
}

enum FoodSource {
  MANUAL
  UPC_API
  PHOTO_API
}

enum MealType {
  BREAKFAST
  LUNCH
  DINNER
  SNACK
  OTHER
}

enum VerificationTokenType {
  EMAIL_VERIFY
  PASSWORD_RESET
}
